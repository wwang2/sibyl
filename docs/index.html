<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sybil Prediction Dashboard - Enhanced</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Space Grotesk', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: #1a1a1a;
            line-height: 1.6;
            font-size: 16px;
            font-weight: 400;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 60px;
            color: #000000;
            background: transparent;
            padding: 0;
            border: none;
            box-shadow: none;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 16px;
            color: #1a1a1a;
            font-weight: 600;
            letter-spacing: -0.02em;
            line-height: 1.2;
        }
        
        .header p {
            font-size: 1.125rem;
            color: #666666;
            font-weight: 400;
            line-height: 1.5;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: #ffffff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        
        .card h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3rem;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .three-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .column {
            background: #ffffff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        
        .column h2 {
            margin-bottom: 20px;
            color: #1a1a1a;
            font-size: 1.25rem;
            font-weight: 600;
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .events-list, .predictions-list, .evidence-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .event-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: none;
        }
        
        .event-card:hover {
            background: #f9fafb;
            transform: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .event-card.selected {
            background: #f0f9ff;
            border-color: #3b82f6;
        }
        
        .event-title {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-size: 1rem;
            line-height: 1.4;
        }
        
        .event-key {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 0.75rem;
            color: #6b7280;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 8px;
        }
        
        .event-description {
            font-size: 0.875rem;
            color: #4b5563;
            line-height: 1.6;
            margin-top: 0;
            padding: 0;
            background: transparent;
            border-radius: 0;
            border: none;
            border-left: none;
            word-wrap: break-word;
            hyphens: auto;
            box-shadow: none;
            font-weight: 400;
        }
        
        .event-description p {
            margin-bottom: 12px;
            line-height: 1.6;
        }
        
        .event-description p:last-child {
            margin-bottom: 0;
        }
        
        .prediction-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: none;
        }
        
        .prediction-card:hover {
            background: #f9fafb;
            transform: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .prediction-card.selected {
            background: #f0fdf4;
            border-color: #22c55e;
        }
        
        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .prediction-id {
            font-family: monospace;
            font-size: 0.8rem;
            color: #666;
        }
        
        .confidence-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .confidence-high {
            background: #d4edda;
            color: #155724;
        }
        
        .confidence-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .confidence-low {
            background: #f8d7da;
            color: #721c24;
        }
        
        .prediction-rationale {
            font-size: 0.875rem;
            color: #4b5563;
            line-height: 1.6;
            margin-top: 8px;
            padding: 0;
            background: transparent;
            border-radius: 0;
            border: none;
            border-left: none;
            word-wrap: break-word;
            hyphens: auto;
            box-shadow: none;
            font-weight: 400;
        }
        
        .prediction-rationale p {
            margin-bottom: 12px;
            line-height: 1.6;
        }
        
        .prediction-rationale p:last-child {
            margin-bottom: 0;
        }
        
        .evidence-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 12px;
            border-left: none;
        }
        
        .evidence-title {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-size: 1rem;
            line-height: 1.4;
        }
        
        .evidence-url {
            font-size: 0.75rem;
            color: #3b82f6;
            text-decoration: none;
            margin-bottom: 8px;
            display: block;
            word-break: break-all;
        }
        
        .evidence-url:hover {
            text-decoration: underline;
        }
        
        .evidence-fact {
            font-size: 0.875rem;
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 8px;
            padding: 0;
            background: transparent;
            border-radius: 0;
            border: none;
            border-left: none;
            word-wrap: break-word;
            hyphens: auto;
            font-weight: 400;
        }
        
        .evidence-fact p {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        .evidence-fact p:last-child {
            margin-bottom: 0;
        }
        
        .evidence-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #888;
        }
        
        .reliability-badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .reliability-high {
            background: #d4edda;
            color: #155724;
        }
        
        .reliability-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .reliability-low {
            background: #f8d7da;
            color: #721c24;
        }
        
        .event-prediction-container {
            background: white;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .event-prediction-container:hover {
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .event-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            cursor: pointer;
            position: relative;
        }
        
        .event-section:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .event-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        
        .event-key {
            font-family: monospace;
            font-size: 0.9rem;
            opacity: 0.8;
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .expand-icon {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }
        
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        .event-description {
            margin-top: 15px;
            font-size: 0.95rem;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .prediction-section {
            padding: 25px;
            border-top: 1px solid #eee;
            position: relative;
        }
        
        .prediction-arrow {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 12px solid #667eea;
        }
        
        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .prediction-id {
            font-family: monospace;
            font-size: 0.9rem;
            color: #666;
        }
        
        .confidence-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .confidence-high {
            background: #d4edda;
            color: #155724;
        }
        
        .confidence-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .confidence-low {
            background: #f8d7da;
            color: #721c24;
        }
        
        .prediction-details {
            font-size: 0.95rem;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .evidence-section {
            margin-top: 20px;
        }
        
        .evidence-toggle {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            transition: background 0.2s ease;
        }
        
        .evidence-toggle:hover {
            background: #e9ecef;
        }
        
        .evidence-count {
            font-size: 0.95rem;
            color: #666;
            font-weight: 500;
        }
        
        .evidence-list {
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .evidence-list.expanded {
            display: block;
        }
        
        .evidence-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            transition: all 0.2s ease;
        }
        
        .evidence-item:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }
        
        .evidence-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .evidence-url {
            font-size: 0.85rem;
            color: #667eea;
            text-decoration: none;
            margin-bottom: 8px;
            display: block;
            word-break: break-all;
        }
        
        .evidence-url:hover {
            text-decoration: underline;
        }
        
        .evidence-fact {
            font-size: 0.875rem;
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 8px;
            padding: 0;
            background: transparent;
            border-radius: 0;
            border: none;
            border-left: none;
            word-wrap: break-word;
            hyphens: auto;
            font-weight: 400;
        }
        
        .evidence-fact p {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        .evidence-fact p:last-child {
            margin-bottom: 0;
        }
        
        .evidence-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #888;
        }
        
        .reliability-badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .reliability-high {
            background: #d4edda;
            color: #155724;
        }
        
        .reliability-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .reliability-low {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: white;
        }
        
        .loading h2 {
            font-size: 2rem;
            margin-bottom: 15px;
        }
        
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .last-updated {
            text-align: center;
            color: #666;
            opacity: 0.8;
            font-size: 0.9rem;
            margin-top: 30px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .three-column-layout {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔮 Sybil Prediction Dashboard</h1>
            <p>AI-powered predictions with structured evidence chains</p>
            <div style="margin-top: 10px; padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 20px; display: inline-block; font-size: 0.9rem;">
                ✨ Enhanced Version - Event-Prediction Relationships
            </div>
        </div>

        <div id="loading" class="loading">
            <h2>Loading prediction data...</h2>
            <p>Fetching latest predictions and evidence chains</p>
                </div>

        <div id="error" class="error" style="display: none;">
            <h3>Error Loading Data</h3>
            <p id="error-message"></p>
            <div style="margin-top: 15px; padding: 10px; background: #e6f3ff; border-radius: 5px;">
                <strong>💡 Quick Fix:</strong>
                <ol style="margin: 10px 0; padding-left: 20px;">
                    <li>Run: <code>make run-enhanced-prediction</code> (to generate data)</li>
                    <li>Run: <code>make serve-dashboard</code> (to start local server)</li>
                    <li>Open: <a href="http://localhost:8080" target="_blank">http://localhost:8080</a></li>
                </ol>
            </div>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-predictions">-</div>
                    <div class="stat-label">Total Predictions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avg-confidence">-</div>
                    <div class="stat-label">Avg Confidence</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="recent-predictions">-</div>
                    <div class="stat-label">Recent (7 days)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="high-confidence">-</div>
                    <div class="stat-label">High Confidence</div>
                </div>
            </div>
            
            <div class="dashboard">
                <div class="card">
                    <h2>📊 Confidence Distribution</h2>
                    <div class="chart-container">
                        <canvas id="confidenceChart"></canvas>
        </div>
        </div>

                <div class="card">
                    <h2>📈 Recent Activity</h2>
                    <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
                </div>
            </div>
            
            <div class="three-column-layout">
                <div class="column events-column">
                    <h2>📋 Events</h2>
                    <div id="events-list" class="events-list">
                        <!-- Events will be loaded here -->
            </div>
        </div>

                <div class="column predictions-column">
                    <h2>🔮 Predictions</h2>
                    <div id="predictions-list" class="predictions-list">
                        <!-- Predictions will be loaded here -->
                    </div>
        </div>

                <div class="column evidence-column">
                    <h2>📚 Evidence</h2>
                    <div id="evidence-list" class="evidence-list">
                        <!-- Evidence will be loaded here -->
                </div>
                </div>
            </div>
        </div>

        <div id="last-updated" class="last-updated" style="display: none;">
            Last updated: <span id="update-time"></span>
                </div>
            </div>
            
    <script>
        let confidenceChart, activityChart;
        
        async function loadPredictionData() {
            try {
                // Check if we're running on file:// protocol
                if (window.location.protocol === 'file:') {
                    throw new Error('Cannot load data from file:// protocol. Please use the local server: make serve-dashboard');
                }
                
                // Load summary data
                const summaryResponse = await fetch('data/prediction_summary.json');
                if (!summaryResponse.ok) {
                    throw new Error(`Failed to load summary: ${summaryResponse.status}. Make sure to run 'make run-enhanced-prediction' first.`);
                }
                const summary = await summaryResponse.json();
                
                // Load detailed predictions
                const predictionsResponse = await fetch('data/predictions.json');
                if (!predictionsResponse.ok) {
                    throw new Error(`Failed to load predictions: ${predictionsResponse.status}. Make sure to run 'make run-enhanced-prediction' first.`);
                }
                const predictions = await predictionsResponse.json();
                
                console.log('Loaded predictions data:', predictions);
                console.log('Number of predictions:', predictions.predictions.length);
                if (predictions.predictions.length > 0) {
                    console.log('First prediction:', predictions.predictions[0]);
                    console.log('First prediction evidence_sources:', predictions.predictions[0].evidence_sources);
                }
                
                // Update stats
                updateStats(summary);
                
                // Create charts
                createCharts(summary, predictions);
                
                // Display predictions with event relationships
                displayEventPredictions(predictions);
                
                // Show dashboard and hide loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('last-updated').style.display = 'block';
                document.getElementById('update-time').textContent = new Date().toLocaleString();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error-message').textContent = error.message;
            }
        }
        
        function updateStats(summary) {
            document.getElementById('total-predictions').textContent = summary.total_predictions;
            document.getElementById('avg-confidence').textContent = (summary.average_confidence * 100).toFixed(1) + '%';
            document.getElementById('recent-predictions').textContent = summary.recent_activity.predictions_last_7_days;
            document.getElementById('high-confidence').textContent = summary.confidence_distribution.high;
        }
        
        function createCharts(summary, predictions) {
            // Confidence Distribution Chart
            const confidenceCtx = document.getElementById('confidenceChart').getContext('2d');
            confidenceChart = new Chart(confidenceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [{
                        data: [
                            summary.confidence_distribution.high,
                            summary.confidence_distribution.medium,
                            summary.confidence_distribution.low
                        ],
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Recent Activity Chart (mock data for now)
            const activityCtx = document.getElementById('activityChart').getContext('2d');
            activityChart = new Chart(activityCtx, {
                type: 'line',
                data: {
                    labels: ['6 days ago', '5 days ago', '4 days ago', '3 days ago', '2 days ago', 'Yesterday', 'Today'],
                    datasets: [{
                        label: 'Predictions',
                        data: [0, 0, 0, 0, 0, 0, summary.recent_activity.predictions_last_7_days],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        let selectedEvent = null;
        let selectedPrediction = null;
        
        function displayEventPredictions(predictions) {
            console.log('displayEventPredictions called with:', predictions);
            
            // Group predictions by event
            const eventGroups = {};
            predictions.predictions.forEach(prediction => {
                const eventKey = prediction.event_key || 'Unknown Event';
                if (!eventGroups[eventKey]) {
                    eventGroups[eventKey] = {
                        event: {
                            id: prediction.event_id,
                            key: prediction.event_key,
                            title: prediction.event_title,
                            description: prediction.event_description
                        },
                        predictions: []
                    };
                }
                eventGroups[eventKey].predictions.push(prediction);
            });
            
            console.log('Event groups created:', eventGroups);
            
            // Display events in left column
            displayEvents(Object.values(eventGroups));
            
            // Clear predictions and evidence initially
            document.getElementById('predictions-list').innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Select an event to view predictions</p>';
            const evidenceContainer = document.getElementById('evidence-list');
            evidenceContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Select a prediction to view evidence</p>';
            evidenceContainer.classList.remove('expanded');
        }
        
        function displayEvents(eventGroups) {
            const eventsContainer = document.getElementById('events-list');
            eventsContainer.innerHTML = '';
            
            eventGroups.forEach(group => {
                const eventCard = document.createElement('div');
                eventCard.className = 'event-card';
                eventCard.onclick = (e) => selectEvent(group, e.currentTarget);
                
                eventCard.innerHTML = `
                    <div class="event-title">${group.event.title || 'Unknown Event'}</div>
                    <div class="event-key">${group.event.key || 'No key'}</div>
                    <div class="event-description">${formatDescription(group.event.description || 'No description available')}</div>
                `;
                
                eventsContainer.appendChild(eventCard);
            });
        }
        
        function selectEvent(eventGroup, clickedElement) {
            // Remove previous selection
            document.querySelectorAll('.event-card').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('.prediction-card').forEach(card => card.classList.remove('selected'));
            
            // Select current event
            clickedElement.classList.add('selected');
            selectedEvent = eventGroup;
            selectedPrediction = null;
            
            // Display predictions for this event
            displayPredictions(eventGroup.predictions);
            
            // Clear evidence
            const evidenceContainer = document.getElementById('evidence-list');
            evidenceContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Select a prediction to view evidence</p>';
            evidenceContainer.classList.remove('expanded');
        }
        
        function displayPredictions(predictions) {
            const predictionsContainer = document.getElementById('predictions-list');
            predictionsContainer.innerHTML = '';
            
            if (predictions.length === 0) {
                predictionsContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No predictions available for this event</p>';
                return;
            }
            
            predictions.forEach(prediction => {
                const predictionCard = document.createElement('div');
                predictionCard.className = 'prediction-card';
                predictionCard.onclick = (e) => selectPrediction(prediction, e.currentTarget);
                
                const confidence = prediction.probability;
                const confidenceClass = confidence >= 0.7 ? 'high' : confidence >= 0.4 ? 'medium' : 'low';
                const confidenceText = (confidence * 100).toFixed(1) + '%';
                
                predictionCard.innerHTML = `
                    <div class="prediction-header">
                        <div class="prediction-id">${prediction.id}</div>
                        <div class="confidence-badge confidence-${confidenceClass}">${confidenceText}</div>
                    </div>
                    <div class="prediction-rationale">
                        ${formatDescription(prediction.rationale || 'No rationale provided')}
                    </div>
                `;
                
                predictionsContainer.appendChild(predictionCard);
            });
        }
        
        function selectPrediction(prediction, clickedElement) {
            console.log('selectPrediction called with:', prediction);
            console.log('Evidence sources:', prediction.evidence_sources);
            
            // Remove previous selection
            document.querySelectorAll('.prediction-card').forEach(card => card.classList.remove('selected'));
            
            // Select current prediction
            clickedElement.classList.add('selected');
            selectedPrediction = prediction;
            
            // Display evidence for this prediction
            displayEvidence(prediction.evidence_sources || []);
        }
        
        function displayEvidence(evidenceSources) {
            console.log('displayEvidence called with:', evidenceSources);
            const evidenceContainer = document.getElementById('evidence-list');
            evidenceContainer.innerHTML = '';
            
            if (evidenceSources.length === 0) {
                console.log('No evidence sources found');
                evidenceContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No evidence available for this prediction</p>';
                evidenceContainer.classList.remove('expanded');
                return;
            }
            
            console.log('Found', evidenceSources.length, 'evidence sources');
            
            // Show the evidence container
            evidenceContainer.classList.add('expanded');
            
            evidenceSources.forEach((source, index) => {
                console.log(`Creating evidence card ${index + 1}:`, source.title);
                const evidenceCard = document.createElement('div');
                evidenceCard.className = 'evidence-card';
                
                const reliability = source.reliability || 'medium';
                const reliabilityClass = reliability === 'high' ? 'high' : reliability === 'medium' ? 'medium' : 'low';
                
                evidenceCard.innerHTML = `
                    <div class="evidence-title">${source.title || 'No title'}</div>
                    <a href="${source.url || '#'}" target="_blank" class="evidence-url">${source.url || 'No URL'}</a>
                    <div class="evidence-fact">${formatDescription(source.extracted_fact || 'No fact extracted')}</div>
                    <div class="evidence-meta">
                        <span>Relevance: ${((source.relevance_score || 0) * 100).toFixed(1)}%</span>
                        <span class="reliability-badge reliability-${reliabilityClass}">${reliability}</span>
                    </div>
                `;
                
                evidenceContainer.appendChild(evidenceCard);
                console.log(`Evidence card ${index + 1} appended to DOM`);
            });
            
            console.log(`Total evidence cards created: ${evidenceSources.length}`);
            console.log(`Evidence container children count: ${evidenceContainer.children.length}`);
        }
        
        
        // Auto-refresh every 5 minutes
        // Format description text for better readability
        function formatDescription(text) {
            if (!text || text === 'No description available' || text === 'No rationale provided' || text === 'No fact extracted') {
                return text;
            }
            
            // Clean up the text
            let formatted = text
                .replace(/\s+/g, ' ')  // Replace multiple spaces with single space
                .trim();
            
            // Split into logical paragraphs based on bullet points and major breaks
            let paragraphs = [];
            
            // Split by bullet points first
            if (formatted.includes('•')) {
                const bulletSections = formatted.split('•');
                paragraphs.push(bulletSections[0].trim()); // First section before bullets
                
                // Process bullet points
                for (let i = 1; i < bulletSections.length; i++) {
                    const bulletText = bulletSections[i].trim();
                    if (bulletText) {
                        paragraphs.push('• ' + bulletText);
                    }
                }
            } else {
                // Split by double periods or other logical breaks
                const sentences = formatted.split(/\. (?=[A-Z])/);
                let currentParagraph = '';
                
                for (let i = 0; i < sentences.length; i++) {
                    const sentence = sentences[i].trim();
                    if (!sentence) continue;
                    
                    // Add period back if it was removed by split
                    if (i < sentences.length - 1 && !sentence.endsWith('.')) {
                        currentParagraph += sentence + '. ';
                    } else {
                        currentParagraph += sentence + ' ';
                    }
                    
                    // Create paragraph breaks every 2-3 sentences or at logical breaks
                    if (currentParagraph.length > 200 || 
                        sentence.includes('confidence') || 
                        sentence.includes('prediction') ||
                        sentence.includes('evidence') ||
                        i === sentences.length - 1) {
                        paragraphs.push(currentParagraph.trim());
                        currentParagraph = '';
                    }
                }
            }
            
            // Wrap each paragraph in <p> tags
            return paragraphs.map(p => `<p>${p}</p>`).join('');
        }

        setInterval(loadPredictionData, 5 * 60 * 1000);
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadPredictionData);
    </script>
</body>
</html>
